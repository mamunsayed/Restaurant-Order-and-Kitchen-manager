<html>
<head>
    <title>Order Details</title>
    <style>
        *{
            box-sizing: border-box;
        }
        body{
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f4f5fb;
        }
        h1{
            width: 900px;
            margin: 20px auto 10px;
            font-size: 26px;
            color: #111827;
        }
        #box{
            width: 900px;
            background-color: #ffffff;
            padding: 20px 30px;
            margin: 10px auto 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(15,23,42,0.08);
        }
        #orderHeader{
            font-size: 14px;
            color: #4b5563;
        }
        #orderHeader span{
            margin-right: 20px;
        }
        fieldset{
            border: none;
            padding: 10px 0;
            margin: 0;
        }
        legend{
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        select{
            width: 250px;
            height: 34px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 14px;
            background-color: #ffffff;
        }
        input[type="text"]{
            width: 100px;
            height: 30px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 14px;
            background-color: #ffffff;
        }
        textarea{
            width: 100%;
            height: 80px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 14px;
            resize: vertical;
            background-color: #ffffff;
        }
        input[type="submit"], input[type="button"]{
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 8px;
            margin-top: 10px;
        }
        #addButton{
            background-color: #2563eb;
            color: white;
        }
        #cancelButton{
            background-color: #e5e7eb;
            color: #111827;
        }
        #sendButton{
            background-color: #2563eb;
            color: white;
        }
        input[type="submit"]:hover, input[type="button"]:hover{
            filter: brightness(0.95);
        }
        table{
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }
        th{
            background-color: #f3f4f6;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        th, td{
            border: 1px solid #e5e7eb;
            padding: 8px 10px;
            text-align: left;
            font-size: 14px;
        }
        tr:nth-child(even) td{
            background-color: #fafafa;
        }
        a{
            text-decoration: none;
            margin-right: 6px;
            font-size: 13px;
            color: #2563eb;
        }
        a:hover{
            text-decoration: underline;
        }
        p{
            margin: 4px 0 0 0;
            font-size: 12px;
            color: #ef4444;
        }
    </style>
</head>
<body>
    <h1>Order Details</h1>

    <div id="box">
        <div id="orderHeader">
            <span>Table: <b id="tableName"></b></span>
            <span>Order ID: <b id="orderId"></b></span>
            <span>Status: <b id="orderStatus"></b></span>
        </div>
        <br>

        <form action="" method="" enctype="" id="itemForm" onsubmit="return addItem()">
            <fieldset>
                <legend>Add Menu Item</legend>
                <table>
                    <tr>
                        <td>Add Menu Item</td>
                        <td>Quantity</td>
                    </tr>
                    <tr>
                        <td>
                            <select id="menuItemSelect" name="menuItemSelect" onblur="testMenuItem()">
                                <option value="">-- Select Item --</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" id="quantity" name="quantity" value="1" onblur="testQuantity()">
                        </td>
                    </tr>
                    <tr>
                        <td><p id="itemError"></p></td>
                        <td><p id="qtyError"></p></td>
                    </tr>
                    <tr>
                        <td colspan="2">Notes (optional)</td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <textarea id="notes" name="notes"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input type="submit" id="addButton" name="" value="Add to Order">
                        </td>
                    </tr>
                </table>
            </fieldset>
        </form>

        <table id="itemsTable">
            <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Notes</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </table>

        <p>Total: $<span id="totalAmount">0.00</span></p>

        <input type="button" id="cancelButton" name="" value="Cancel Order" onclick="cancelOrder()">
        <input type="button" id="sendButton" name="" value="Send to Kitchen" onclick="sendToKitchen()">
    </div>

    
    <script>
        let itemError = document.getElementById('itemError');
        let qtyError = document.getElementById('qtyError');
        let itemsTable = document.getElementById('itemsTable');
        let totalAmount = document.getElementById('totalAmount');
        let tableNameSpan = document.getElementById('tableName');
        let orderIdSpan = document.getElementById('orderId');
        let orderStatusSpan = document.getElementById('orderStatus');
        let editIndex = -1;
        let currentOrder = null;
        let menuItems = [];

        function getOrders(){
            let data = localStorage.getItem('orders');
            if(data == null || data == ""){
                return [];
            }else{
                return JSON.parse(data);
            }
        }

        function saveOrders(orders){
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        function getCurrentOrderId(){
            let query = window.location.search;
            let id = "";
            if(query.indexOf('?') != -1){
                let parts = query.substring(1).split('&');
                for(let i=0; i<parts.length; i++){
                    let pair = parts[i].split('=');
                    if(pair[0] == 'id'){
                        id = pair[1];
                    }
                }
            }
            if(id == "" || id == null){
                id = localStorage.getItem('currentOrderId');
            }
            return parseInt(id);
        }

        function loadOrder(){
            let orderId = getCurrentOrderId();
            let orders = getOrders();
            for(let i=0; i<orders.length; i++){
                if(orders[i].id == orderId){
                    currentOrder = orders[i];
                    break;
                }
            }
            if(currentOrder == null){
                currentOrder = {
                    id: orderId,
                    table: "",
                    status: "Open",
                    items: []
                };
            }
            if(currentOrder.items == null){
                currentOrder.items = [];
            }
            tableNameSpan.innerHTML = currentOrder.table;
            orderIdSpan.innerHTML = currentOrder.id;
            orderStatusSpan.innerHTML = currentOrder.status;
        }

        function loadMenuItems(){
            let data = localStorage.getItem('menuItems');
            if(data != null && data != ""){
                menuItems = JSON.parse(data);
            }else{
                menuItems = [];
            }
            let select = document.getElementById('menuItemSelect');
            while(select.options.length > 1){
                select.remove(1);
            }
            for(let i=0; i<menuItems.length; i++){
                if(menuItems[i].availability == "Available"){
                    let option = document.createElement('option');
                    option.value = i;
                    option.text = menuItems[i].name + " ($" + menuItems[i].price + ")";
                    select.appendChild(option);
                }
            }
        }

        function showItems(){
            while(itemsTable.rows.length > 1){
                itemsTable.deleteRow(1);
            }
            for(let i=0; i<currentOrder.items.length; i++){
                let row = itemsTable.insertRow(-1);

                let cell1 = row.insertCell(0);
                cell1.innerHTML = currentOrder.items[i].name;

                let cell2 = row.insertCell(1);
                cell2.innerHTML = currentOrder.items[i].qty;

                let cell3 = row.insertCell(2);
                cell3.innerHTML = currentOrder.items[i].price;

                let cell4 = row.insertCell(3);
                cell4.innerHTML = currentOrder.items[i].notes;

                let cell5 = row.insertCell(4);
                cell5.innerHTML = currentOrder.items[i].status;

                let cell6 = row.insertCell(5);
                cell6.innerHTML = '<a href="#" onclick="toggleItemStatus('+i+')">Status</a><a href="#" onclick="editItem('+i+')">Edit</a><a href="#" onclick="deleteItem('+i+')">Delete</a>';
            }
            calculateTotal();
        }

        function calculateTotal(){
            let total = 0;
            for(let i=0; i<currentOrder.items.length; i++){
                let price = parseFloat(currentOrder.items[i].price);
                let qty = parseInt(currentOrder.items[i].qty);
                if(isNaN(price)){
                    price = 0;
                }
                if(isNaN(qty)){
                    qty = 0;
                }
                total = total + (price * qty);
            }
            totalAmount.innerHTML = total.toFixed(2);
        }

        function saveCurrentOrder(){
            let orders = getOrders();
            let found = false;
            for(let i=0; i<orders.length; i++){
                if(orders[i].id == currentOrder.id){
                    orders[i] = currentOrder;
                    found = true;
                    break;
                }
            }
            if(found == false){
                orders.push(currentOrder);
            }
            saveOrders(orders);
        }

        function testMenuItem(){
            let value = document.getElementById('menuItemSelect').value;
            if(value == "" && editIndex == -1){
                itemError.innerHTML = "please select an item!";
                itemError.style.color = 'red';
            }else{
                itemError.innerHTML = "";
            }
        }

        function testQuantity(){
            let qty = document.getElementById('quantity').value;
            qty = qty.trim();
            if(qty == ""){
                qtyError.innerHTML = "please type quantity first!";
                qtyError.style.color = 'red';
            }else if(isNaN(qty)){
                qtyError.innerHTML = "quantity must be a number!";
                qtyError.style.color = 'red';
            }else if(parseInt(qty) <= 0){
                qtyError.innerHTML = "quantity must be greater than 0!";
                qtyError.style.color = 'red';
            }else{
                qtyError.innerHTML = "";
            }
        }

        function clearForm(){
            document.getElementById('menuItemSelect').value = "";
            document.getElementById('menuItemSelect').disabled = false;
            document.getElementById('quantity').value = "1";
            document.getElementById('notes').value = "";
            document.getElementById('addButton').value = "Add to Order";
            editIndex = -1;
        }

        function addItem(){
            testMenuItem();
            testQuantity();
            if(itemError.innerHTML !== "" || qtyError.innerHTML !== ""){
                return false;
            }else{
                let qty = document.getElementById('quantity').value;
                let notes = document.getElementById('notes').value;
                if(editIndex == -1){
                    let itemIndex = document.getElementById('menuItemSelect').value;
                    let menuItem = menuItems[itemIndex];
                    if(menuItem == null){
                        return false;
                    }
                    let orderItem = {
                        name: menuItem.name,
                        qty: parseInt(qty),
                        price: menuItem.price,
                        notes: notes,
                        status: "Pending"
                    };
                    currentOrder.items.push(orderItem);
                }else{
                    currentOrder.items[editIndex].qty = parseInt(qty);
                    currentOrder.items[editIndex].notes = notes;
                }
                saveCurrentOrder();
                showItems();
                clearForm();
                return false;
            }
        }

        function editItem(index){
            let item = currentOrder.items[index];
            document.getElementById('quantity').value = item.qty;
            document.getElementById('notes').value = item.notes;
            document.getElementById('menuItemSelect').disabled = true;
            document.getElementById('addButton').value = "Update Item";
            editIndex = index;
        }

        function deleteItem(index){
            currentOrder.items.splice(index,1);
            saveCurrentOrder();
            showItems();
            clearForm();
        }

        function toggleItemStatus(index){
            let item = currentOrder.items[index];
            if(item.status == "Pending"){
                item.status = "Done";
            }else{
                item.status = "Pending";
            }
            currentOrder.items[index] = item;
            saveCurrentOrder();
            showItems();
        }

        function cancelOrder(){
            currentOrder.status = "Cancelled";
            orderStatusSpan.innerHTML = currentOrder.status;
            saveCurrentOrder();
            window.location.href = "orders_start.html";
        }

        function sendToKitchen(){
            currentOrder.status = "Sent";
            orderStatusSpan.innerHTML = currentOrder.status;
            saveCurrentOrder();
        }

        loadOrder();
        loadMenuItems();
        showItems();
    </script>
</body>
</html>