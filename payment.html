<html>
<head>
    <title>Payment</title>
    <style>
        *{
            box-sizing: border-box;
        }
        body{
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f4f5fb;
        }
        h1{
            width: 900px;
            margin: 20px auto 10px;
            font-size: 26px;
            color: #111827;
        }
        #box{
            width: 900px;
            background-color: #ffffff;
            padding: 20px 30px;
            margin: 10px auto 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(15,23,42,0.08);
        }
        #header{
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 8px;
        }
        fieldset{
            border: none;
            padding: 10px 0;
            margin: 0;
        }
        legend{
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        table{
            width: 100%;
            border-collapse: collapse;
            background-color: #ffffff;
            margin-top: 10px;
        }
        th{
            background-color: #f3f4f6;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        th, td{
            padding: 10px 12px;
            text-align: left;
            vertical-align: middle;
        }
        tr:nth-child(even) td{
            background-color: #fafafa;
        }
        input[type="text"]{
            width: 120px;
            height: 30px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 8px;
            background-color: #ffffff;
            font-size: 14px;
        }
        select{
            width: 180px;
            height: 34px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 8px;
            background-color: #ffffff;
            font-size: 14px;
        }
        input[type="button"]{
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 8px;
            margin-top: 8px;
        }
        #calcButton, #payButton{
            background-color: #2563eb;
            color: #ffffff;
        }
        #printButton{
            background-color: #e5e7eb;
            color: #111827;
        }
        input[type="button"]:hover{
            filter: brightness(0.95);
        }
        p{
            margin: 4px 0 0 0;
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <h1>Payment</h1>

    <div id="box">
        <div id="header">
            Order: <b id="orderIdText"></b> | Table: <b id="tableNameText"></b>
        </div>

        <fieldset>
            <legend>Invoice</legend>

            <table id="itemsTable">
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Line Total</th>
                </tr>
            </table>

            <table>
                <tr>
                    <td>Subtotal</td>
                    <td id="subtotalText">$0.00</td>
                    <td>Total Payable</td>
                    <td style="text-align:right">$<span id="totalPayableText">0.00</span></td>
                </tr>
                <tr>
                    <td>Discount</td>
                    <td id="discountText">-$0.00</td>
                    <td>Discount</td>
                    <td>
                        <input type="text" id="discountValue" value="0" onblur="testDiscount()">
                        <select id="discountType">
                            <option value="flat">Flat (Currency)</option>
                            <option value="percent">Percent (%)</option>
                        </select>
                        <p id="dError"></p>
                    </td>
                </tr>
                <tr>
                    <td>Tax</td>
                    <td id="taxText">$0.00</td>
                    <td>Tax %</td>
                    <td>
                        <input type="text" id="taxPercent" value="5" onblur="testTax()">
                        <p id="tError"></p>
                    </td>
                </tr>
                <tr>
                    <td>Service Charge</td>
                    <td id="serviceText">$0.00</td>
                    <td>Service Charge %</td>
                    <td>
                        <input type="text" id="servicePercent" value="10" onblur="testService()">
                        <p id="sError"></p>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="2">
                        <input type="button" id="calcButton" name="" value="Calculate Bill" onclick="calculateBill()">
                        <input type="button" id="printButton" name="" value="Print Invoice" onclick="window.print()">
                    </td>
                </tr>
            </table>
        </fieldset>

        <fieldset>
            <legend>Payment</legend>
            <table>
                <tr>
                    <td>Payment Method</td>
                    <td>Amount Received</td>
                    <td>Transaction ID (for card/digital)</td>
                </tr>
                <tr>
                    <td>
                        <select id="paymentMethod" name="paymentMethod" onblur="testMethod()">
                            <option value="">-- Select Method --</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Digital">Digital Wallet</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" id="amountReceived" name="amountReceived" value="0.00" onblur="testAmount()">
                    </td>
                    <td>
                        <input type="text" id="transactionId" name="transactionId" value="">
                    </td>
                </tr>
                <tr>
                    <td><p id="mError"></p></td>
                    <td><p id="aError"></p></td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="3">
                        <input type="button" id="payButton" name="" value="Complete Payment" onclick="completePayment()">
                    </td>
                </tr>
            </table>

            <p>
                Payment Status: <b id="paymentStatusText"></b> |
                Order Status: <b id="orderStatusText"></b> |
                Table Status: <b id="tableStatusText"></b>
            </p>
        </fieldset>
    </div>

    <script>
        let orderIdText = document.getElementById('orderIdText');
        let tableNameText = document.getElementById('tableNameText');
        let itemsTable = document.getElementById('itemsTable');
        let subtotalText = document.getElementById('subtotalText');
        let discountText = document.getElementById('discountText');
        let taxText = document.getElementById('taxText');
        let serviceText = document.getElementById('serviceText');
        let totalPayableText = document.getElementById('totalPayableText');

        let discountInput = document.getElementById('discountValue');
        let discountTypeSelect = document.getElementById('discountType');
        let taxPercentInput = document.getElementById('taxPercent');
        let servicePercentInput = document.getElementById('servicePercent');

        let dError = document.getElementById('dError');
        let tError = document.getElementById('tError');
        let sError = document.getElementById('sError');

        let paymentMethodSelect = document.getElementById('paymentMethod');
        let amountReceivedInput = document.getElementById('amountReceived');
        let mError = document.getElementById('mError');
        let aError = document.getElementById('aError');

        let paymentStatusText = document.getElementById('paymentStatusText');
        let orderStatusText = document.getElementById('orderStatusText');
        let tableStatusText = document.getElementById('tableStatusText');

        let currentOrder = null;
        let currentSubtotal = 0;
        let grandTotal = 0;

        function getOrders(){
            let data = localStorage.getItem('orders');
            if(data == null || data == ""){
                return [];
            }else{
                return JSON.parse(data);
            }
        }

        function saveOrders(orders){
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        function getBillingOrderId(){
            let id = localStorage.getItem('billingOrderId');
            if(id == null || id == ""){
                return 0;
            }else{
                return parseInt(id);
            }
        }

        function loadOrder(){
            let id = getBillingOrderId();
            let orders = getOrders();
            for(let i=0; i<orders.length; i++){
                if(orders[i].id == id){
                    currentOrder = orders[i];
                    break;
                }
            }
            if(currentOrder == null){
                currentOrder = {
                    id: id,
                    table: "",
                    status: "Sent",
                    items: []
                };
            }
            if(currentOrder.items == null){
                currentOrder.items = [];
            }
            if(currentOrder.billing == null){
                currentOrder.billing = {
                    discountValue: 0,
                    discountType: "flat",
                    discountAmount: 0,
                    taxPercent: 5,
                    taxAmount: 0,
                    servicePercent: 10,
                    serviceAmount: 0,
                    totalPayable: 0
                };
            }
            if(currentOrder.paymentStatus == null){
                currentOrder.paymentStatus = "Unpaid";
            }
            orderIdText.innerHTML = currentOrder.id;
            tableNameText.innerHTML = currentOrder.table;
        }

        function showItems(){
            while(itemsTable.rows.length > 1){
                itemsTable.deleteRow(1);
            }
            currentSubtotal = 0;
            for(let i=0; i<currentOrder.items.length; i++){
                let row = itemsTable.insertRow(-1);
                let price = parseFloat(currentOrder.items[i].price);
                let qty = parseInt(currentOrder.items[i].qty);
                if(isNaN(price)){price = 0;}
                if(isNaN(qty)){qty = 0;}
                let lineTotal = price * qty;

                let cell1 = row.insertCell(0);
                cell1.innerHTML = currentOrder.items[i].name;

                let cell2 = row.insertCell(1);
                cell2.innerHTML = qty;

                let cell3 = row.insertCell(2);
                cell3.innerHTML = "$" + price.toFixed(2);

                let cell4 = row.insertCell(3);
                cell4.innerHTML = "$" + lineTotal.toFixed(2);

                currentSubtotal = currentSubtotal + lineTotal;
            }
            subtotalText.innerHTML = "$" + currentSubtotal.toFixed(2);
            loadBillingValues();
        }

        function loadBillingValues(){
            let b = currentOrder.billing;
            discountInput.value = b.discountValue;
            discountTypeSelect.value = b.discountType;
            taxPercentInput.value = b.taxPercent;
            servicePercentInput.value = b.servicePercent;

            discountText.innerHTML = "-$" + b.discountAmount.toFixed(2);
            taxText.innerHTML = "$" + b.taxAmount.toFixed(2);
            serviceText.innerHTML = "$" + b.serviceAmount.toFixed(2);

            grandTotal = b.totalPayable;
            if(isNaN(grandTotal) || grandTotal == 0){
                grandTotal = currentSubtotal;
            }
            totalPayableText.innerHTML = grandTotal.toFixed(2);
            amountReceivedInput.value = grandTotal.toFixed(2);

            updateStatusTexts();
        }

        function updateStatusTexts(){
            paymentStatusText.innerHTML = currentOrder.paymentStatus;
            orderStatusText.innerHTML = currentOrder.status;
            if(currentOrder.paymentStatus == "Paid"){
                tableStatusText.innerHTML = "Available";
            }else{
                tableStatusText.innerHTML = "Occupied";
            }
        }

        function testDiscount(){
            let d = discountInput.value;
            d = d.trim();
            if(d == ""){
                dError.innerHTML = "please type discount, 0 if none!";
                dError.style.color = 'red';
            }else if(isNaN(d)){
                dError.innerHTML = "discount must be a number!";
                dError.style.color = 'red';
            }else if(parseFloat(d) < 0){
                dError.innerHTML = "discount cannot be negative!";
                dError.style.color = 'red';
            }else{
                dError.innerHTML = "";
            }
        }

        function testTax(){
            let t = taxPercentInput.value;
            t = t.trim();
            if(t == ""){
                tError.innerHTML = "please type tax %, 0 if none!";
                tError.style.color = 'red';
            }else if(isNaN(t)){
                tError.innerHTML = "tax % must be a number!";
                tError.style.color = 'red';
            }else if(parseFloat(t) < 0){
                tError.innerHTML = "tax % cannot be negative!";
                tError.style.color = 'red';
            }else{
                tError.innerHTML = "";
            }
        }

        function testService(){
            let s = servicePercentInput.value;
            s = s.trim();
            if(s == ""){
                sError.innerHTML = "please type service %, 0 if none!";
                sError.style.color = 'red';
            }else if(isNaN(s)){
                sError.innerHTML = "service % must be a number!";
                sError.style.color = 'red';
            }else if(parseFloat(s) < 0){
                sError.innerHTML = "service % cannot be negative!";
                sError.style.color = 'red';
            }else{
                sError.innerHTML = "";
            }
        }

        function calculateBill(){
            testDiscount();
            testTax();
            testService();
            if(dError.innerHTML !== "" || tError.innerHTML !== "" || sError.innerHTML !== ""){
                return;
            }
            let discountValue = parseFloat(discountInput.value);
            let discountType = discountTypeSelect.value;
            let taxPercent = parseFloat(taxPercentInput.value);
            let servicePercent = parseFloat(servicePercentInput.value);

            if(isNaN(discountValue)){discountValue = 0;}
            if(isNaN(taxPercent)){taxPercent = 0;}
            if(isNaN(servicePercent)){servicePercent = 0;}

            let discountAmount = 0;
            if(discountType == "flat"){
                discountAmount = discountValue;
            }else{
                discountAmount = currentSubtotal * (discountValue/100);
            }
            if(discountAmount > currentSubtotal){
                discountAmount = currentSubtotal;
            }
            let net = currentSubtotal - discountAmount;

            let taxAmount = net * (taxPercent/100);
            let serviceAmount = net * (servicePercent/100);
            let totalPayable = net + taxAmount + serviceAmount;

            discountText.innerHTML = "-$" + discountAmount.toFixed(2);
            taxText.innerHTML = "$" + taxAmount.toFixed(2);
            serviceText.innerHTML = "$" + serviceAmount.toFixed(2);
            totalPayableText.innerHTML = totalPayable.toFixed(2);

            currentOrder.billing.discountValue = discountValue;
            currentOrder.billing.discountType = discountType;
            currentOrder.billing.discountAmount = discountAmount;
            currentOrder.billing.taxPercent = taxPercent;
            currentOrder.billing.taxAmount = taxAmount;
            currentOrder.billing.servicePercent = servicePercent;
            currentOrder.billing.serviceAmount = serviceAmount;
            currentOrder.billing.totalPayable = totalPayable;
            currentOrder.paymentStatus = currentOrder.paymentStatus || "Unpaid";

            grandTotal = totalPayable;
            amountReceivedInput.value = grandTotal.toFixed(2);

            let orders = getOrders();
            let found = false;
            for(let i=0; i<orders.length; i++){
                if(orders[i].id == currentOrder.id){
                    orders[i] = currentOrder;
                    found = true;
                    break;
                }
            }
            if(found == false){
                orders.push(currentOrder);
            }
            saveOrders(orders);
            updateStatusTexts();
        }

        function testMethod(){
            let m = paymentMethodSelect.value;
            if(m == ""){
                mError.innerHTML = "please select payment method!";
                mError.style.color = 'red';
            }else{
                mError.innerHTML = "";
            }
        }

        function testAmount(){
            let a = amountReceivedInput.value;
            a = a.trim();
            if(a == ""){
                aError.innerHTML = "please type amount received!";
                aError.style.color = 'red';
            }else if(isNaN(a)){
                aError.innerHTML = "amount must be a number!";
                aError.style.color = 'red';
            }else if(parseFloat(a) < grandTotal){
                aError.innerHTML = "amount must be at least total payable!";
                aError.style.color = 'red';
            }else{
                aError.innerHTML = "";
            }
        }

        function completePayment(){
            testMethod();
            testAmount();
            if(mError.innerHTML !== "" || aError.innerHTML !== ""){
                return;
            }
            currentOrder.paymentStatus = "Paid";
            currentOrder.status = "Closed";

            let orders = getOrders();
            let found = false;
            for(let i=0; i<orders.length; i++){
                if(orders[i].id == currentOrder.id){
                    orders[i] = currentOrder;
                    found = true;
                    break;
                }
            }
            if(found == false){
                orders.push(currentOrder);
            }
            saveOrders(orders);
            updateStatusTexts();
        }

        loadOrder();
        showItems();
        calculateBill();
    </script>
</body>
</html>